# 네트워크 보안

## AWS 네트워크

- VPC: 고정 파티션
- Subnet: 유동 파티션

### MSA 네트워크 계층 만들기

1. 격리

- 동일한 비지니스 도메인별로 분리한다.

2. 연결

- 도메인 간 통신이 필요한 경우 연결한다.

### 서브네팅

- VPC 내 IP 주소공간을 더 작은 크기로 분할하고 서비스별 그룹화 하는 방법
- 가용 영역 수준의 파티션(az내부)

** 라우팅 테이블**

- 서브넷이 통신 가능하도록 네트워크 파티션을 지정하여 규칙 제어

### 게이트웨이

1. IGW

- VPC와 인터넷을 연결해준다.

2. NATGW

- 프라이빗 서비스가 인터넷 통신 가능하도록 해준다.
- 퍼블릭 서브넷에 위치하며 퍼블릭IP로 변환한다.
- 송신 요청이 있다면, 수신 요청을 자동 허용한다.

3. 송신전용 IGW

- IPv6 주소를 사용하는 서브넷의 인터넷 접근 허용.

## VPC 간 통신

1. Peering

- VPC끼리 직접 연결하는 방법으로, 프라이빗 IP로도 트래픽 라우팅 가능.
- VPC IP주소가 겹치면 안되기 때문에 전략적 설계 필요.
- 피어링 생성이후 각 VPC내 라우팅 테이블에 '피어링' 등록 필요.
- 피어링 간 전송 데이터 비용 발생 & 다른 리전에 있어도 전송비용 추가 발생.

2. Transit Gateway

- 자체 라우팅 테이블을 가지고 여러 VPC를 연결하고 라우팅 해준다.
- '허브 앤 스포크 모델'을 사용
- 홉으로 지연이 발생할 수 있음
- 트래픽 수신 여부와 무관하여 고정된 시간당 요금 지불 + 네트워크 연결당 지불 요금
- 전송되는 데이터 양에 비례하여 과금

3. PrivateLink & Endpoint

- 공급자-소비자 패턴이 명확한 경우 사용

### Gateway - VPC Endpoint

- DynamoDB, S3만 지원
- 게이트웨이 형태로 VPC 내 존재

### Interface/PrivateLink - VPC Endpoint

- VPC 내부에 ENI를 생성함
- 공급자: PrivateLink로 생성
- 소비자: 가용영역별 서브넷에 추가해야함
- 공급자(VPC외부 단일 서비스)가 늘어날 수록 비용 증가
- 동일 서비스에 연결하려는 서브넷이 많을 수록 중복생성으로 비용 증가

## 방화벽

### Security Group

- 디폴트 '차단' 유형 -> '허용' 규칙 추가
- 다른 보안 그룹을 참조하여 '체인(연결)' 가능
- 상태저장(stateful): 요청 정보 저장으로 응답 자동 허용

### NACL

- 디폴트 '허용' 유형
- '악성 트래픽' 등을 허용/거부 가능함
- '규칙 번호'를 오름차순으로 평가함
- 상태비저장(stateless): 인&아웃바운드에서 설정 필요

### 컨테이너 네트워크 보안

1. 인스턴스 메타데이터 서비스(IMDS) 차단

- 파드가 사용할 역할&권한을 의도와 다르게 가질 수 있기 때문에 접근을 차단해야함.

2. 파드를 프라이빗 서브넷에서 실행

- 파드가 인터넷에 직접 접근 할 경우가 적기 때문에 프라이빗 서브넷 권장.

3. 파드 간 암호화된 네트워킹 사용

- Cilium 솔루션 또는 EC2 Nitro 인스턴스 사용(AES 암호화 네트워킹 지원)

### 람다 네트워크 보안

- VPC 프라이빗 서브넷에서 연결해서 내부 리소스와 액세스 하는 경우
  - 람다와 VPC를 연결
    - 각 서브넷마다 Hyperplane ENI에 함수를 할당해서 사용할 것.
    - Hyperplane: Lambda VPC에서 Customer VPC로 NAT 기능
      ![](https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/08/28/v2n-architecture-1024x613.png)
