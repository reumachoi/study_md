# 대외 공개 서비스
> 엣지서버: 애플리케이션 경계 지점에 위치하여 대외적으로 공개된 서비스들

## API Gateway 
- 클라이언트 진입 API 제공 서비스
- TLS 종료 처리 + 인증/인가 + 라우팅

### 엔드포인트 유형
1. 리전
- 기본 유형. 리전 단위 서비스로 배포 리전 선택.
2. 최적화
- 지리적 분산을 통한 빠른 응답 및 장애 대응 조치 가능.
- 내부적으로 CloudFront 사용.
3. 프라이빗
- 내부 요청을 처리하기 위함.

### 통합 서비스
1. 람다
- 람다 함수를 호출 대상으로 지정.
2. HTTP
- 퍼블릭 HTTP 엔드포인트 호출
3. VPC 링크
- VPC 내부 리소스(ALB 등)와 연결하기 위한 ENI 생성.

### 접근 통제
1. IAM = API기반 권한 부여자
- 호출자의 신원 확인 후 인증인가(STS AssumeRole)
- Authorization 헤더와 함께 요청
2. Cognito 권한 부여자
- 사용자 풀을 기반으로 관리
- JWT 토큰과 함께 요청
3. Lmabda 권한 부여자
- 람다에 사용자 요청 전달 및 커스텀 인가 백엔드 서비스에서 허용/거부

### 인프라 보안
1. 요청 제한
- 지속적인 요청 비율: 장기간 걸쳐 요청 받는 평균 비율
- 버스트 요청 비율: 보통 1초 미만 동안 임계값을 넘어오는 요청의 속도 제한을 위한 버퍼 크기. 임계값 도달시 429 Error.  
> ex) 초당 5000개 제한 
>  - 1초에 10000개를 균등하게 보내면 -> 모두 처리
>  - 1밀리초에 10000개 -> 5000개만 처리 후 1초 제한
>  - 1밀리초에 5000개 + 999밀리초 5000개 -> 모두 처리

2. 클라이언트별 요청 제한
- API 키를 통한 사용자 식별 및 접근 측정 => 사용량 계획

#### 상호 TLS
- 유효성 검증을 위하 루트&중간 CA의 공개키를 API Gateway에 업로드 해야함

### 비용 고려 사항
- API 사용시에만 청구
- 잘못된 요청(인증 실패, 액세스 키 누락 등)의 경우 미청구
- 요청 한도 설정시 청구
- 전송된 메시지 수, WebSocket 엔드포인트 연결기간에 따라 청구
- 데이터 캐싱 기능 활성화시 저장되는 시간별 청구
- 교차리전 호출시 리전 간 데이터 전송 비용 청구

## Bastion Host
- VPC 퍼블릭 서브넷 내 배치
- 아웃바운드 차단 및, 내부 목적지로의 SSH 인바운드만 허용

## CloudFront(CDN)
- 애플리케이션 가용성을 위해 증가하는 요청에 맞게 확장하여 수용할 수 있음
- 위치와 현재 트래픽 기반 처리
- 엣지 로케이션의 캐시 확인 및 없는 경우에만 오리진 요청
- 보안 규정 준수 걱정 불필요
> 오리진 대상
> - S3 Bucket
> - ELB
> - Elemental MediaStore Container
> - Elemental MediaPackage Endpoint
> - EC2...

### 원본 액세스 보안
- S3의 경우 OAC/OAI 설정을 통해 버킷 접근을 CloudFront 배포만 허용 세팅

### 서명된 URL & Cookie
- 디지털 서명과 비대칭키 암호화로 인증&인가 처리
- 요청자가 원하는 일정 시간 동안 접근 허용
- '개인키'로 요청에 서명 -> '공개키'로 복호화 및 확인

#### URL vs Cookie
- URL: 객체별 생성시 번거로움. 세분화된 접근 통제를 선호하는 경우 추천(멤버십 등). 
- Cookie: 통합 접근 제공시 편리. URL 미변경으로 접근 가능.
![pre-signed](https://miro.medium.com/v2/resize:fit:1400/1*8Dj6h2TI9WsTI4NEU18PZQ.png)


## Lambda@Edge
- 엣지 로케이션에서 람다기반 서비스 실행
- 보안관련 헤더 추가 가능(X-XSS-Protection, Content-security-Policy, X-Content-Type-Options)
1. 뷰어 요청: 요청이 로케이션 도착시 트리거
2. 원본 요청: 캐싱 데이터가 없어 오리진에 요청시 트리거
3. 원본 응답: 오리진 요청 응답 반환 후 트리거
4. 뷰어 응답: 뷰어에게 응답 반환 전 트리거

## 네트워크 공격 보호 서비스
### WAF
1. 규칙
    - 개수: 요청 수 합산
    - 허용: 리소스 전달
    - 차단: 요청 차단 + HTTP 403
2. 규칙 그룹: 규칙의 모음
3. IP 집합: 화이트리스트, 블랙리스트
4. 정규식 패턴 집합
5. 웹 ACL: 여러 기준들로 검사 및 처리

#### 추가 규칙
- 알려진 취약점(SQL Injection, XSS...)
- 속도 기반 규칙: 임계 기간과 허용수를 초과하는 IP 차단(포괄적, 특정 URI에 대한 속도 확인)
- Marketplace에서 구독 가능

### Shield
- 애플리케이션 중지시간 및 지연시간 최소화를 위해 DDos 보호 서비스

#### Shield Advanced
- 별도 활성화로 사용자 NACL을 AWS 경계로 적용 가능.
- NACL로 VPC 내부 침입 차단.
- 연중무휴 AWS 도움 요청 가능
- 대규모 7계층 공격 탐지시 DRT(데이터 검색 도구)가 사용자에게 연락 + WAF 규칙 생성 및 안내
  - 보안 조치를 수락/거부 가능
- 보호 그룹으로 사용자가 지정 가능(정확도 향상 및 오탐지 감소화, 신규 생성 리소스 자동 보호 간소화...)
- 공격에 대응하여 리소스 확장시 크레딧 요청 가능(요금 보호 기능)

### 비용
- WAF
  - 생성한 웹 ACL 시간당 요금 부과 + 생성한 개별 규칙 시간당 부과
  - 차단/허용과 무관하게 처리하는 웹 요청당 비용 부과
- Shield
  - Standard: 무료
  - Advanced: 월별 요금 청구