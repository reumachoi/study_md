# 모니터링과 사고 대응

## 사고 대응 계획(IR-4 6단계)

1. 설계 및 준비

- 피해 가능성을 낮추는 조치, 보안 감지를 위한 모니터링 & 로깅 수행

2. 탐지 및 분석

- 보안 발생 여부 감지 및 확증을 위한 정보 수집 및 평가

3. 억제 및 격리

- 피해 증가를 막기 위한 통제 구현으로 위험 최소화

4. 포렌식 분석

- 사고 원인 분석

5. 재발 방지

- 향후 동일 사고 방지를 위한 조치 수행

6. 사후 활동

- 취약점 해결 후 정상 상태로 점진적으로 복구 진행 + 문서화

## 1. 설계 및 준비

- 사전 예방적 통제 설정
- MSA 도메인 단위 경계 컨텍스트 그룹화로 신속하게 격리 가능

### 활동 로깅

- CloudTrail로 모든 사요자의 API 요청 & 활동 모니터링
  - JSON 형식으로 S3 버킷에 저장

> CloudWatch는 실행중인 앱의 로그 저장, CloudTrail은 API 호출 등 인프라 변경

#### CloudTrail 이벤트 유형

1. 관리 이벤트(컨트롤 플레인)

- 리소스 관리와 관한 작업(보안정책, 리소스 신규생성...)

2. 데이터 이벤트(데이터 플레인)

- 이미 존재하는 리소스 내 수행 작업 이력

3. Insights 이벤트

- 일반적이지 않은 비정상 활동 포착

#### VPC 플로우 로그

- VPC 내 네트워크 인터페이스(OSI 3Layer)에서 송수신하는 트래픽 정보를 캡쳐하는 기능
- 서브넷 / 네트워크 인터페이스 단위 생성 가능

### 모니터링

#### CloudWatch

네임스페이스: 지표 집합

**핵심요소**

- 데이터 포인트: 통계 데이터 집합
- 지표: 추적대상 정보 벡터(시간기반)
- 차원: 지표 구분으로 이름/값 쌍
- 해상도: 포인트 샘플링 조정(시간단위 변화

-> 데이터 포인트 = 특정 순간 데이터
-> 지표 = 데이터 라인연결(흐름)
-> 차원 = 각 대상/서비스 단위 분류
-> 해상도 = 분단위(표준), 초단위(고해상도)

#### 종합 모니터링

- CloudWatch Synthetics: 시스템 내 가능한 행동 등을 모방하고자 '행동 스크립트' 생성
- SSM 에이전트: 인스턴스 관리&설정 가능
- Macie: S3 내 민감 데이터 모니터링 및 평가

## 2. 탐지 및 분석

파악해야 하는 부분

- 공격 종류
- 침해된 리소스 확인
- 권한 탈취 또는 리소스 도용으로 외부 공격 여부
- 사고 외 나머지 영역 정상작동을 위한 최소한의 조치

### 전조 증상

- 취약점 스캐너
- VPC 플로우 로그 -> 포트 스캐너 사용 파악
- 인증요청 거부 횟수 급격한 증가
- 웹앱 대상 인바운드 트래픽 패턴 급격 변화

#### EventBridge 활용

- 이벤트 버스로 이벤트 수집 -> 규칙으로 이벤트 평가
- 서드파티 통합 / HTTP나 AWS 리소스 호출

## 3. 억제 및 격리

### 3-1. 인프라 침해

1. 스냅샷 캡쳐
2. 인스턴스 중단
3. 격리(NACL)
4. 안화(리소스 제거)
5. 기록유지(태깅 등)

### 3-2. 애플리케이션 침해

- 취약점 평가를 위해 별도 격리된 환경으로 이동 후 분석(동일한 이슈 가능성 유)

## 4. 포렌식 분석

### Athena

- S3 로그파일을 분석하기 좋은 도구

### 라이브 박스 포렌식

- 보안사고가 있는 리소스를 계속 실행상태에 두고 분석
- 메모리 덤프 결과로 악성코드 패턴 분석
- 인스턴스 메모리, 캐시 등 증거 보존 및 수집

### 데드 박스 포렌식

- 스냅샷을 통한 재생성 -> 사고 이전으로 되돌리거나 재생성으로 병렬 분석 가능
- 메모리 중요정보 손실시 분석 어려움

### 디지털 포렌식 분석 도구

1. SSM
2. EventBridge: 특정 이벤트 재실행(replay)
3. 마켓플레이스 솔루션

## 5. 재발 방지

- CMK를 통한 민감 데이터, 스냅샷 재암호화
- 사용자 비밀번호 강제 변경 및 강력 암호 정책 적용
- 손상된 데이터에 리소스 태깅 및 추가모니터링

### 보안 태세

- 모든 권한 주체에 MFA 적용
- 모든 접근 패턴 차단 -> 신규 방화벽
- 비인가 접근 허용 가능성이 있는 역할 접근 제한

## 6. 사후 활동

- 복구: 안전한 스냅샷이나 파일, 코드 사용 + 지속 모니터링
- 시뮬레이션 및 반복: 완전하지 않은 패치를 개선하기 위함

## 보안 인프라 보호

### CloudTrail 보안

- S3 로그 암호화 저장
- 로그 검증(변조, 규제 준수 여부 입증)

### 목적 기반 계정

- 로깅 별도 저장을 위한 계정 생성
- 저장작업만 수행하는 역할 생성
- 읽기작업만 수행하는 역할 생성
